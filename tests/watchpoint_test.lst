# file opened: watchpoint_test.asm
  1   0000              ; a quick routine to help test new watchpoints in beastem
  2   0000
  3   0000              ; *NB* cant actually use these if we've mapped the BIOS out!!
  4   0000              get_page_mapping EQU	0x0FDDC 	; Return the logical (cpu) page C (0-2) in A
  5   0000              set_page_mapping EQU	0x0FDDF 	; Set the logical (cpu) page in A (0-2) to the physical (RAM/ROM) page in E
  6   0000
  7   0000              ; we'll have to talk directly to the port instead
  8   0000              IO_MEM_0            EQU    070h      ; Page 0: 0000h - 3fffh
  9   0000              IO_MEM_1            EQU    071h      ; Page 1: 4000h - 7fffh
 10   0000              IO_MEM_2            EQU    072h      ; Page 2: 8000h - bfffh
 11   0000              IO_MEM_3            EQU    073h      ; Page 3: c000h - ffffh
 12   0000              IO_MEM_CTRL         EQU    074h      ; Paging enable register
 13   0000              IO_MEM_ENABLE       EQU    1
 14   0000              IO_MEM_DISABLE      EQU    0
 15   0000
 16   0000              		OUTPUT	wptest.com
 17   0000              		ORG	0x0100
 18   0100
 19   0100              ; first some basic watchpoint fodder
 20   0100              ; loop reads from 0x10xx & writes to 0x20xx
 21   0100              ; then reads from 0x20xx & writes to 0x10xx
 22   0100              copy1
 23   0100 21 00 10     		LD	HL, 0x1000
 24   0103 11 00 20     		LD	DE, 0x2000
 25   0106 06 FF        		LD	B, 0xFF
 26   0108
 27   0108 7E           loop		LD	A, (HL)
 28   0109 12           		LD	(DE), A
 29   010A
 30   010A 1A           		LD	A, (DE)
 31   010B 77           		LD	(HL), A
 32   010C
 33   010C 23           		INC	HL
 34   010D 13           		INC	DE
 35   010E 10 F8        		DJNZ	loop
 36   0110
 37   0110              ; now we move on to some more advanced shenanigans
 38   0110
 39   0110              mappo_worko
 40   0110              ; now do some freaky mapping so that we can test
 41   0110              ; *physical* watchpoints are working separately from
 42   0110              ; logical ones.
 43   0110              ;
 44   0110              ; FIRST make sure that mapping is enabled!
 45   0110 3E 01        		LD	A, IO_MEM_ENABLE
 46   0112 D3 74        		OUT	(IO_MEM_CTRL), A
 47   0114
 48   0114              ; a "crossover" mapping:
 49   0114              ; we map 8000-bfff => 84000-87fff
 50   0114              ;    and c000-ffff => 80000-83fff
 51   0114              ;
 52   0114              ; set watchpoints on: 0x84000,ff
 53   0114              ;                     0x80000,ff
 54   0114              ; observe that when you break the logical address is
 55   0114              ; different from the lower 16 bits of the watchpoint address
 56   0114
 57   0114 0E 72        		LD	C, IO_MEM_2	; logical page 2
 58   0116 1E 21        		LD	E, 0x21	; physical page 21
 59   0118 ED 59        		OUT	(C), E
 60   011A
 61   011A 0E 73        		LD	C, IO_MEM_3	; logical page 3
 62   011C 1E 20        		LD	E, 0x20	; physical page 20
 63   011E ED 59        		OUT	(C), E
 64   0120
 65   0120 18 14        		JR	copy2
 66   0122
 67   0122              ; BROKEN! can't call BIOS if it is mapped out!!!
 68   0122              mappo_no_worko
 69   0122              ; now do some freaky mapping so that we can test
 70   0122              ; *physical* watchpoints are working separately from
 71   0122              ; logical ones.
 72   0122              ;
 73   0122              ; we map 8000-bfff => 84000-87fff
 74   0122              ;    and c000-ffff => 80000-83fff
 75   0122 3E 02        		LD	A, 2	; logical page 2
 76   0124 1E 21        		LD	E, 0x21	; physical page 21
 77   0126 CD DF FD     		CALL	set_page_mapping
 78   0129 D2 46 01     		JP	NC, bad_mapping
 79   012C
 80   012C 3E 03        		LD	A, 3	; logical page 3
 81   012E 1E 20        		LD	E, 0x20	; physical page 20
 82   0130 CD DF FD     		CALL	set_page_mapping
 83   0133 D2 46 01     		JP	NC, bad_mapping
 84   0136
 85   0136              copy2
 86   0136 21 00 80     		LD	HL, 0x8000
 87   0139 11 00 C0     		LD	DE, 0xc000
 88   013C 06 FF        		LD	B, 0xFF
 89   013E
 90   013E 7E           loop2		LD	A, (HL)
 91   013F 12           		LD	(DE), A
 92   0140
 93   0140 1A           		LD	A, (DE)
 94   0141 77           		LD	(HL), A
 95   0142
 96   0142 23           		INC	HL
 97   0143 13           		INC	DE
 98   0144 10 F8        		DJNZ	loop2
 99   0146
100   0146 18 FE        bad_mapping	JR	bad_mapping
101   0148
102   0148
# file closed: watchpoint_test.asm
